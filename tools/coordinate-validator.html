<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validateur de Coordonn√©es - Paris Explorer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #1e3a8a;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, textarea, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #1e3a8a;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #1e40af;
        }
        .place-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .place-item.error {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .place-item.warning {
            border-color: #d97706;
            background: #fffbeb;
        }
        .place-item.ok {
            border-color: #059669;
            background: #ecfdf5;
        }
        .coords {
            font-family: monospace;
            background: #e5e7eb;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
        }
        .suggestions {
            background: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin: 20px 0;
        }
        .batch-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .progress {
            background: #e5e7eb;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            background: #059669;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1e3a8a;
        }
        .export-section {
            background: #f0f9ff;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Validateur de Coordonn√©es - Paris Explorer</h1>
        <p>Outil de validation et correction des coordonn√©es GPS des lieux parisiens</p>
    </div>

    <div class="controls">
        <h3>üîß Contr√¥les</h3>
        <div class="batch-controls">
            <input type="file" id="jsonFile" accept=".json" multiple>
            <button onclick="loadFromFiles()">üìÅ Charger fichiers JSON</button>
            <button onclick="validateAll()">‚úÖ Valider toutes les coordonn√©es</button>
            <button onclick="searchAndFix()">üîç Rechercher et corriger automatiquement</button>
            <button onclick="exportResults()">üìä Exporter les r√©sultats</button>
        </div>
        
        <div style="margin: 15px 0;">
            <label>
                <input type="checkbox" id="useNominatim" checked> 
                Utiliser Nominatim (OpenStreetMap) pour la validation
            </label>
            <label>
                <input type="checkbox" id="strictMode"> 
                Mode strict (coordonn√©es doivent √™tre exactement √† Paris)
            </label>
        </div>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="progressText"></div>
    </div>

    <div class="stats" id="statsContainer" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="totalPlaces">0</div>
            <div>Lieux Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="validCoords">0</div>
            <div>Coordonn√©es Valides</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="invalidCoords">0</div>
            <div>Coordonn√©es Invalides</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="missingCoords">0</div>
            <div>Coordonn√©es Manquantes</div>
        </div>
    </div>

    <div class="export-section" id="exportSection" style="display: none;">
        <h3>üìä Export des R√©sultats</h3>
        <button onclick="downloadCorrectionScript()">üì• T√©l√©charger script de correction</button>
        <button onclick="downloadReport()">üìÑ T√©l√©charger rapport complet</button>
        <button onclick="downloadFixedJSON()">üîß T√©l√©charger JSON corrig√©s</button>
    </div>

    <div class="results">
        <h3>üìç R√©sultats de Validation</h3>
        <div id="results"></div>
    </div>

    <!-- Carte Leaflet -->
    <div id="map"></div>

    <!-- Leaflet CSS et JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map;
        let allPlacesData = [];
        let validationResults = [];
        let currentValidationIndex = 0;

        // Initialiser la carte
        function initMap() {
            map = L.map('map').setView([48.8566, 2.3522], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Zone de Paris approximative
            const parisBounds = L.rectangle([
                [48.815, 2.224],
                [48.902, 2.469]
            ], {
                color: '#1e3a8a',
                weight: 2,
                fillOpacity: 0.1
            }).addTo(map);
        }

        // Charger les fichiers JSON
        function loadFromFiles() {
            const files = document.getElementById('jsonFile').files;
            if (files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier JSON');
                return;
            }

            allPlacesData = [];
            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processArrondissementData(data, file.name);
                        filesProcessed++;
                        
                        if (filesProcessed === files.length) {
                            displayStats();
                            document.getElementById('statsContainer').style.display = 'grid';
                        }
                    } catch (error) {
                        console.error('Erreur lecture fichier', file.name, error);
                    }
                };
                reader.readAsText(file);
            });
        }

        // Traiter les donn√©es d'un arrondissement
        function processArrondissementData(data, filename) {
            const arrData = data.arrondissement;
            if (!arrData || !arrData.categories) return;

            const arrKey = arrData.id || filename.replace('.json', '');

            Object.entries(arrData.categories).forEach(([catKey, catData]) => {
                if (!catData.places) return;

                catData.places.forEach(place => {
                    allPlacesData.push({
                        arrondissement: arrKey,
                        category: catKey,
                        place: place,
                        filename: filename,
                        originalData: data
                    });
                });
            });
        }

        // Valider toutes les coordonn√©es
        async function validateAll() {
            if (allPlacesData.length === 0) {
                alert('Veuillez d\'abord charger des fichiers JSON');
                return;
            }

            validationResults = [];
            currentValidationIndex = 0;

            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').textContent = 'Validation en cours...';

            for (let i = 0; i < allPlacesData.length; i++) {
                const item = allPlacesData[i];
                const result = await validatePlace(item);
                validationResults.push(result);
                
                currentValidationIndex = i + 1;
                updateProgress();
                
                // Pause pour √©viter de surcharger l'API
                if (document.getElementById('useNominatim').checked) {
                    await sleep(1000);
                }
            }

            displayResults();
            displayStats();
            document.getElementById('exportSection').style.display = 'block';
        }

        // Valider un lieu sp√©cifique
        async function validatePlace(item) {
            const place = item.place;
            const coords = place.coordinates;
            
            let status = 'unknown';
            let issues = [];
            let suggestions = [];
            let apiResult = null;

            // Validation basique des coordonn√©es
            if (!coords || !Array.isArray(coords) || coords.length < 2) {
                status = 'missing';
                issues.push('Coordonn√©es manquantes');
            } else {
                const lat = parseFloat(coords[0]);
                const lng = parseFloat(coords[1]);

                if (isNaN(lat) || isNaN(lng)) {
                    status = 'invalid';
                    issues.push('Coordonn√©es non num√©riques');
                } else {
                    // V√©rification des limites de Paris
                    const strictMode = document.getElementById('strictMode').checked;
                    const parisLat = lat >= 48.815 && lat <= 48.902;
                    const parisLng = lng >= 2.224 && lng <= 2.469;

                    if (strictMode && (!parisLat || !parisLng)) {
                        status = 'invalid';
                        issues.push('Coordonn√©es hors de Paris');
                    } else if (!parisLat || !parisLng) {
                        status = 'warning';
                        issues.push('Coordonn√©es possiblement hors de Paris');
                    } else {
                        status = 'valid';
                    }

                    // Validation avec Nominatim si activ√©e
                    if (document.getElementById('useNominatim').checked && place.name) {
                        try {
                            apiResult = await searchNominatim(place.name + ', Paris, France');
                            
                            if (apiResult && apiResult.length > 0) {
                                const apiLat = parseFloat(apiResult[0].lat);
                                const apiLng = parseFloat(apiResult[0].lon);
                                
                                const distance = calculateDistance(lat, lng, apiLat, apiLng);
                                
                                if (distance > 1) { // Plus de 1km de diff√©rence
                                    status = 'warning';
                                    issues.push(`Distance de ${distance.toFixed(0)}m avec Nominatim`);
                                    suggestions.push(`Nominatim sugg√®re: [${apiLat}, ${apiLng}]`);
                                }
                            }
                        } catch (error) {
                            console.warn('Erreur API Nominatim pour', place.name, error);
                        }
                    }
                }
            }

            return {
                ...item,
                status,
                issues,
                suggestions,
                apiResult,
                currentCoords: coords
            };
        }

        // Recherche Nominatim
        async function searchNominatim(query) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=fr`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erreur Nominatim:', error);
                return null;
            }
        }

        // Calculer la distance entre deux points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Rayon de la Terre en m√®tres
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Afficher les r√©sultats
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const grouped = {};
            validationResults.forEach(result => {
                const key = result.arrondissement;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(result);
            });

            Object.entries(grouped).forEach(([arr, results]) => {
                const arrDiv = document.createElement('div');
                arrDiv.innerHTML = `<h4>üìç ${arr}</h4>`;
                
                results.forEach(result => {
                    const placeDiv = document.createElement('div');
                    placeDiv.className = `place-item ${result.status}`;
                    
                    const coordsText = result.currentCoords ? 
                        `<span class="coords">[${result.currentCoords[0]}, ${result.currentCoords[1]}]</span>` : 
                        '<span class="coords">Pas de coordonn√©es</span>';
                    
                    placeDiv.innerHTML = `
                        <strong>${result.place.name}</strong> - ${result.category}<br>
                        ${coordsText}<br>
                        <small>Statut: ${result.status} | Issues: ${result.issues.join(', ')}</small>
                        ${result.suggestions.length > 0 ? `
                            <div class="suggestions">
                                <strong>Suggestions:</strong><br>
                                ${result.suggestions.join('<br>')}
                            </div>
                        ` : ''}
                    `;
                    
                    // Ajouter marker sur la carte
                    if (result.currentCoords) {
                        const color = result.status === 'valid' ? 'green' : result.status === 'warning' ? 'orange' : 'red';
                        L.circleMarker(result.currentCoords, { color, radius: 5 })
                            .addTo(map)
                            .bindPopup(`${result.place.name}<br>Status: ${result.status}`);
                    }
                    
                    arrDiv.appendChild(placeDiv);
                });
                
                resultsDiv.appendChild(arrDiv);
            });
        }

        // Afficher les statistiques
        function displayStats() {
            const total = allPlacesData.length;
            const valid = validationResults.filter(r => r.status === 'valid').length;
            const invalid = validationResults.filter(r => r.status === 'invalid').length;
            const missing = validationResults.filter(r => r.status === 'missing').length;

            document.getElementById('totalPlaces').textContent = total;
            document.getElementById('validCoords').textContent = valid;
            document.getElementById('invalidCoords').textContent = invalid;
            document.getElementById('missingCoords').textContent = missing;
        }

        // Mettre √† jour la barre de progression
        function updateProgress() {
            const percent = (currentValidationIndex / allPlacesData.length) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = 
                `${currentValidationIndex}/${allPlacesData.length} lieux valid√©s (${percent.toFixed(1)}%)`;
        }

        // T√©l√©charger le rapport
        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: {
                    total: allPlacesData.length,
                    valid: validationResults.filter(r => r.status === 'valid').length,
                    invalid: validationResults.filter(r => r.status === 'invalid').length,
                    missing: validationResults.filter(r => r.status === 'missing').length,
                    warnings: validationResults.filter(r => r.status === 'warning').length
                },
                results: validationResults
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rapport-coordonnees-paris.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Utilitaire sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialiser l'outil
        initMap();
    </script>
</body>
</html>